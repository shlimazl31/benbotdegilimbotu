import { SlashCommandBuilder } from 'discord.js';
import { checkQueueState, setLastNowPlayingMessage, clearLastNowPlayingMessage, updateQueueState } from '../../utils/player.js';
import { EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } from 'discord.js';
import { useMainPlayer } from 'discord-player';

export default {
    data: new SlashCommandBuilder()
        .setName('nowplaying')
        .setDescription('≈ûu anda √ßalan ≈üarkƒ±yƒ± g√∂sterir'),

    async execute(interaction) {
        try {
            // Kullanƒ±cƒ±nƒ±n ses kanalƒ±nda olup olmadƒ±ƒüƒ±nƒ± kontrol et
            const member = interaction.member;
            if (!member.voice.channel) {
                const embed = new EmbedBuilder()
                    .setTitle('‚ùå Hata')
                    .setDescription('Bu komutu kullanmak i√ßin bir ses kanalƒ±nda olmalƒ±sƒ±n!')
                    .setColor('#FF0000');
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }

            // Player'ƒ± al
            const player = useMainPlayer();
            const queue = player.nodes.get(interaction.guild.id);

            // Kuyruk durumunu kontrol et
            if (!queue || !queue.isPlaying()) {
                const embed = new EmbedBuilder()
                    .setTitle('‚ùå Hata')
                    .setDescription('≈ûu anda √ßalan bir ≈üarkƒ± yok!')
                    .setColor('#FF0000');
                return interaction.reply({ embeds: [embed], ephemeral: true });
            }

            // √ñnceki mesajƒ± temizle
            await clearLastNowPlayingMessage(interaction.guild.id);

            const track = queue.currentTrack;
            const progress = queue.node.getTimestamp();
            const progressBar = createProgressBar(progress.current.value, progress.total.value);

            // Embed olu≈ütur
            const embed = new EmbedBuilder()
                .setTitle('üéµ ≈ûimdi √áalƒ±yor')
                .setDescription(`**${track.title}**`)
                .addFields(
                    { name: 'üë§ Sanat√ßƒ±', value: track.author, inline: true },
                    { name: '‚è±Ô∏è S√ºre', value: `${progress.current.label} / ${progress.total.label}`, inline: true },
                    { name: 'üîä Ses', value: `${queue.node.volume}%`, inline: true },
                    { name: 'üìä ƒ∞lerleme', value: progressBar, inline: false }
                )
                .setThumbnail(track.thumbnail)
                .setColor(getColorByGenre(track.genre))
                .setFooter({ 
                    text: `ƒ∞steyen: ${track.requestedBy.tag}`,
                    iconURL: track.requestedBy.displayAvatarURL()
                });

            // Butonlarƒ± olu≈ütur
            const row = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('pause')
                        .setLabel(queue.node.isPaused() ? '‚ñ∂Ô∏è Devam Et' : '‚è∏Ô∏è Duraklat')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('skip')
                        .setLabel('‚è≠Ô∏è Ge√ß')
                        .setStyle(ButtonStyle.Secondary),
                    new ButtonBuilder()
                        .setCustomId('loop')
                        .setLabel(queue.repeatMode === 0 ? 'üîÅ Tekrarla' : 'üîÅ Tekrarƒ± Kapat')
                        .setStyle(queue.repeatMode === 0 ? ButtonStyle.Secondary : ButtonStyle.Success),
                    new ButtonBuilder()
                        .setCustomId('shuffle')
                        .setLabel('üîÄ Karƒ±≈ütƒ±r')
                        .setStyle(ButtonStyle.Danger),
                    new ButtonBuilder()
                        .setCustomId('stop')
                        .setLabel('‚èπÔ∏è Durdur')
                        .setStyle(ButtonStyle.Danger)
                );

            // Mesajƒ± g√∂nder
            const message = await interaction.reply({ 
                embeds: [embed], 
                components: [row],
                fetchReply: true 
            });

            // Mesajƒ± kaydet
            setLastNowPlayingMessage(interaction.guild.id, message);

            // Buton etkile≈üimlerini dinle
            const collector = message.createMessageComponentCollector({ 
                time: 300000 // 5 dakika
            });

            collector.on('collect', async (i) => {
                if (i.user.id !== interaction.user.id) {
                    return i.reply({ 
                        content: '‚ùå Bu butonlarƒ± sadece komutu kullanan ki≈üi kullanabilir!', 
                        ephemeral: true 
                    });
                }

                try {
                    const currentQueue = player.nodes.get(i.guild.id);
                    if (!currentQueue || !currentQueue.isPlaying()) {
                        return i.reply({
                            content: '‚ùå ≈ûu anda √ßalan bir ≈üarkƒ± yok!',
                            ephemeral: true
                        });
                    }

                    switch (i.customId) {
                        case 'pause':
                            currentQueue.node.setPaused(!currentQueue.node.isPaused());
                            await i.update({
                                components: [
                                    new ActionRowBuilder()
                                        .addComponents(
                                            new ButtonBuilder()
                                                .setCustomId('pause')
                                                .setLabel(currentQueue.node.isPaused() ? '‚ñ∂Ô∏è Devam Et' : '‚è∏Ô∏è Duraklat')
                                                .setStyle(ButtonStyle.Primary),
                                            new ButtonBuilder()
                                                .setCustomId('skip')
                                                .setLabel('‚è≠Ô∏è Ge√ß')
                                                .setStyle(ButtonStyle.Secondary),
                                            new ButtonBuilder()
                                                .setCustomId('loop')
                                                .setLabel(currentQueue.repeatMode === 0 ? 'üîÅ Tekrarla' : 'üîÅ Tekrarƒ± Kapat')
                                                .setStyle(currentQueue.repeatMode === 0 ? ButtonStyle.Secondary : ButtonStyle.Success),
                                            new ButtonBuilder()
                                                .setCustomId('shuffle')
                                                .setLabel('üîÄ Karƒ±≈ütƒ±r')
                                                .setStyle(ButtonStyle.Danger),
                                            new ButtonBuilder()
                                                .setCustomId('stop')
                                                .setLabel('‚èπÔ∏è Durdur')
                                                .setStyle(ButtonStyle.Danger)
                                        )
                                ]
                            });
                            break;

                        case 'skip':
                            currentQueue.node.skip();
                            await i.update({ components: [] });
                            break;

                        case 'loop':
                            currentQueue.setRepeatMode(currentQueue.repeatMode === 0 ? 1 : 0);
                            await i.update({
                                components: [
                                    new ActionRowBuilder()
                                        .addComponents(
                                            new ButtonBuilder()
                                                .setCustomId('pause')
                                                .setLabel(currentQueue.node.isPaused() ? '‚ñ∂Ô∏è Devam Et' : '‚è∏Ô∏è Duraklat')
                                                .setStyle(ButtonStyle.Primary),
                                            new ButtonBuilder()
                                                .setCustomId('skip')
                                                .setLabel('‚è≠Ô∏è Ge√ß')
                                                .setStyle(ButtonStyle.Secondary),
                                            new ButtonBuilder()
                                                .setCustomId('loop')
                                                .setLabel(currentQueue.repeatMode === 0 ? 'üîÅ Tekrarla' : 'üîÅ Tekrarƒ± Kapat')
                                                .setStyle(currentQueue.repeatMode === 0 ? ButtonStyle.Secondary : ButtonStyle.Success),
                                            new ButtonBuilder()
                                                .setCustomId('shuffle')
                                                .setLabel('üîÄ Karƒ±≈ütƒ±r')
                                                .setStyle(ButtonStyle.Danger),
                                            new ButtonBuilder()
                                                .setCustomId('stop')
                                                .setLabel('‚èπÔ∏è Durdur')
                                                .setStyle(ButtonStyle.Danger)
                                        )
                                ]
                            });
                            break;

                        case 'shuffle':
                            currentQueue.tracks.shuffle();
                            await i.update({ components: [] });
                            break;

                        case 'stop':
                            currentQueue.delete();
                            await i.update({ components: [] });
                            break;
                    }
                } catch (error) {
                    console.error('Buton etkile≈üimi hatasƒ±:', error);
                    await i.reply({ 
                        content: '‚ùå Bir hata olu≈ütu!', 
                        ephemeral: true 
                    });
                }
            });

            collector.on('end', () => {
                // Butonlarƒ± devre dƒ±≈üƒ± bƒ±rak
                const disabledRow = new ActionRowBuilder()
                    .addComponents(
                        row.components.map(button => 
                            ButtonBuilder.from(button.data)
                                .setDisabled(true)
                        )
                    );

                message.edit({ components: [disabledRow] }).catch(console.error);
            });

            // Her 10 saniyede bir mesajƒ± g√ºncelle
            const updateInterval = setInterval(async () => {
                try {
                    const currentQueue = player.nodes.get(interaction.guild.id);
                    if (!currentQueue || !currentQueue.isPlaying()) {
                        clearInterval(updateInterval);
                        return;
                    }

                    const currentTrack = currentQueue.currentTrack;
                    if (!currentTrack) {
                        clearInterval(updateInterval);
                        return;
                    }

                    const progress = currentQueue.node.getTimestamp();
                    const progressBar = createProgressBar(progress.current.value, progress.total.value);

                    embed.setFields(
                        { name: 'üë§ Sanat√ßƒ±', value: currentTrack.author, inline: true },
                        { name: '‚è±Ô∏è S√ºre', value: `${progress.current.label} / ${progress.total.label}`, inline: true },
                        { name: 'üîä Ses', value: `${currentQueue.node.volume}%`, inline: true },
                        { name: 'üìä ƒ∞lerleme', value: progressBar, inline: false }
                    );

                    await message.edit({ embeds: [embed] });
                } catch (error) {
                    console.error('Mesaj g√ºncelleme hatasƒ±:', error);
                    clearInterval(updateInterval);
                }
            }, 10000);

        } catch (error) {
            console.error('Nowplaying komutu hatasƒ±:', error);
            const errorEmbed = new EmbedBuilder()
                .setTitle('‚ùå Sistem Hatasƒ±')
                .setDescription('Bir hata olu≈ütu! L√ºtfen daha sonra tekrar deneyin.')
                .setColor('#FF0000');
            await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
        }
    }
};

// Yardƒ±mcƒ± fonksiyonlar
function createProgressBar(current, total) {
    const length = 20;
    const filled = Math.round((current / total) * length);
    const empty = length - filled;
    
    return `[${'‚ñà'.repeat(filled)}${'‚ñë'.repeat(empty)}]`;
}

function getColorByGenre(genre) {
    const colors = {
        'pop': '#FF69B4',
        'rock': '#FF0000',
        'hip-hop': '#FFA500',
        'jazz': '#4B0082',
        'classical': '#800080',
        'electronic': '#00FFFF',
        'r&b': '#FF1493',
        'country': '#32CD32',
        'metal': '#696969',
        'folk': '#DEB887'
    };

    return colors[genre?.toLowerCase()] || '#FF0000';
} 